# 文献管理系统 - 论文创建功能修复报告

## 问题描述

系统在创建新论文时出现错误，错误信息为：

```
ERROR:app.utils:创建论文失败: (sqlite3.IntegrityError) UNIQUE constraint failed: papers.doi
```

这表明系统数据库中 `papers` 表的 `doi` 字段存在唯一性约束，导致无法创建具有相同 DOI 的文献。

## 问题分析

1. 数据库设计问题：
   - `papers` 表的 `doi` 字段设置了唯一性约束
   - 但在实际使用中，可能需要记录多个具有相同 DOI 的论文（例如不同版本、不同来源）

2. 错误堆栈分析：
   - 错误发生在论文创建过程中的数据库提交阶段
   - 系统尝试插入的 DOI 值 `10.1016/S0261-5177（03）00131-6` 已经存在于数据库中

## 修复方案

我们采用了以下方法修复问题：

1. 创建了 `fix_papers_doi.py` 脚本，移除 `papers` 表中 `doi` 字段的唯一性约束
   - 由于 SQLite 不支持直接修改约束，我们通过以下步骤实现：
     - 创建一个新的没有 DOI 唯一约束的临时表
     - 将原表数据复制到新表
     - 删除原表并将新表重命名

2. 验证修复：
   - 创建了 `check_db.py` 脚本检查数据库结构
   - 通过测试确认 DOI 字段不再有唯一性约束
   - 成功验证可以插入具有相同 DOI 的多条记录

## 技术详情

### 修复脚本

主要修复脚本 `fix_papers_doi.py` 的核心逻辑：

```python
def remove_doi_constraint():
    """移除papers表中DOI的唯一性约束"""
    # 在SQLite中移除约束的唯一方法是重建表
    with engine.connect() as conn:
        # 1. 获取现有表的所有列定义
        # 2. 创建新表（不包含DOI唯一约束）
        # 3. 复制数据到新表
        # 4. 删除旧表
        # 5. 重命名新表为原名
```

### 验证脚本

验证脚本 `check_db.py` 的主要功能：

```python
def check_papers_doi():
    """特别检查papers表中的DOI字段是否有唯一约束"""
    # 检查papers表的索引，查找是否存在DOI唯一约束
    # 测试插入具有相同DOI的两条记录
```

## 修复后效果

修复后：
1. 系统可以创建多篇具有相同 DOI 的论文
2. 数据库表结构更加符合实际业务需求
3. 用户在创建论文时不会再遇到 DOI 唯一性错误

## 注意事项和建议

1. **数据完整性**：
   - 移除 DOI 唯一约束后，需要在应用层实现适当的逻辑来处理相同 DOI 的多篇论文

2. **用户界面考虑**：
   - 可能需要更新用户界面，在显示论文列表时提示用户有多篇相同 DOI 的论文

3. **未来改进**：
   - 考虑在论文创建时添加重复检测功能，提醒用户可能在创建重复论文
   - 可以实现合并功能，允许用户合并具有相同 DOI 的多篇论文

## 结论

通过移除 `papers` 表中 `doi` 字段的唯一性约束，我们成功解决了创建论文时的错误。这个修复使系统能够更灵活地处理论文数据，允许记录具有相同 DOI 的多篇论文。 